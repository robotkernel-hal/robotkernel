# -*- mode: makefile -*-

# to build and install (locally) for all supported architectures just execute:
#  make -f Makefile.suggested -j16 build_all
#  (2:30 on rmc-uranos, 192MB binaries)
#
# to configure/build/install only a single architecture execute:
#  make -f Makefile.suggested ARCH=sled11-x86-gcc4.x configure build install

# settings:
#LN_BASE=/home/schm_fl/workspace/ln_base/install/links_and_nodes/0.2.0
#LN_BASE=${HOME}/workspace/ln_base

include supported_archs.mk

JOBS=16
ARGS=

# architecture specific settings
ifeq ($(ARCH),sled11-x86-gcc4.x)
#SOURCE_ENV="source $(CURDIR)/scripts/sled11-x86-gcc4.x.env"
endif

ifeq ($(ARCH),sled11-x86_64-gcc4.x)
ifneq ($(shell uname -m),x86_64)
SSH=ssh rmc-thalia
endif
#SOURCE_ENV="source $(CURDIR)/scripts/sled11-x86_64-gcc4.x.env"
endif

ifeq ($(ARCH),angstrom-armv7-gcc4.7)
OECORE_ROOT=/home/schm_fl/data/local/oecore-i686
HOST_OPTION=--host=arm-angstrom-linux-gnueabi
TOOLCHAIN=${OECORE_ROOT}/sysroots/i686-angstromsdk-linux/usr/bin/armv7a-vfp-neon-angstrom-linux-gnueabi/
#SOURCE_ENV="source $(SRC_DIR)/scripts/linux-gnueabi-rmpm-hack.sh"
endif

ifeq ($(ARCH),ubuntu12.04-armhf-gcc4.x)
HOST_OPTION=--host=arm-linux-gnueabihf
TOOLCHAIN=/volume/USERSTORE/f_xrotor/Gumstix/Linux_Toolchain/gcc-linaro-arm-linux-gnueabihf-4.7-2013.04-20130415_linux/bin
endif

ifeq ($(findstring vxworks,$(ARCH)),vxworks)
TOOLCHAIN=/opt/vxworks/wrapper/linux/bin_configure/
HOST_OPTION=--host=$(shell ./scripts/arch_from_dlrrm $(ARCH))
ARGS+=PKG_CONFIG=/bin/false 
#SOURCE_ENV="source $(CURDIR)/scripts/$(ARCH).env"
endif

ifeq ($(ARCH),qnx6.3-x86-gcc3.3)
HOST_OPTION=--host=$(shell ./scripts/arch_from_dlrrm $(ARCH))
#SOURCE_ENV="source $(CURDIR)/scripts/$(ARCH).env"
CXX="QCC -V 3.3.5,gcc_ntox86_cpp -fmessage-length=0 -fexceptions"
CC="QCC -V 3.3.5,gcc_ntox86_cpp -fmessage-length=0"
ARGS+=PKG_CONFIG=/bin/false CC=$(CC) CXX=$(CXX) 
endif

ifeq ($(ARCH),qnx6.5-x86-gcc4.x)
HOST_OPTION=--host=$(shell ./scripts/arch_from_dlrrm $(ARCH))
#SOURCE_ENV="source $(CURDIR)/scripts/$(ARCH).env"
CXX="QCC -fmessage-length=0 -Wno-write-strings -fexceptions"
CC="QCC -lang-c -fmessage-length=0 -Wno-write-strings" 
AR="ar"
ARGS+=PKG_CONFIG=/bin/false CC=$(CC) CXX=$(CXX) AR=$(AR) 
endif

ifeq ($(ARCH),qnx6.5-x86-gcc4.x-gpp)
HOST_OPTION=--host=$(shell ./scripts/arch_from_dlrrm $(ARCH))
#SOURCE_ENV="source $(CURDIR)/scripts/$(ARCH).env"
CXX="QCC -V 4.4.2,gcc_ntox86_gpp -fmessage-length=0 -Wno-write-strings"
CC="QCC -V 4.4.2,gcc_ntox86_gpp -lang-c -fmessage-length=0 -Wno-write-strings" 
AR="ar"
ARGS+=PKG_CONFIG=/bin/false CC=$(CC) CXX=$(CXX) AR=$(AR)
endif

SRC_DIR=$(CURDIR)
DST_DIR=$(SRC_DIR)/build/$(ARCH)

ifneq ($(TOOLCHAIN),)
	ARGS+="TOOLCHAIN=$(TOOLCHAIN)"
endif

ifneq ($(PKG_CONFIG_PATH),)
	ARGS+="PKG_CONFIG_PATH=$(PKG_CONFIG_PATH)"
endif

# targets
.PHONY: configure build install build_all build_all_seq $(SUPPORTED_ARCHS)

build_all: $(SUPPORTED_ARCHS)

build_all_seq:
	set -e; for arch in $(SUPPORTED_ARCHS); do echo $$arch; make ARCH=$$arch -f Makefile.suggested -j1  configure build install; done

$(SUPPORTED_ARCHS):
	make ARCH=$@ -f Makefile.suggested configure install

configure:
ifeq ($(SSH),)
	mkdir -p $(DST_DIR)
	cd $(DST_DIR); $(SRC_DIR)/configure --build=$(shell $(SRC_DIR)/config.guess) $(HOST_OPTION) SOURCE_ENV=$(CURDIR)/scripts/$(ARCH).env DLRRM_ARCH=$(ARCH) LN_BASE="${LN_BASE}" $(ARGS) --prefix=$(DST_DIR)/install 
else
	$(SSH) make -C $(SRC_DIR) -f Makefile.suggested ARCH=$(ARCH) configure
endif

build:
	$(SSH) make -j $(JOBS) -C $(DST_DIR)

install: build
	$(SSH) make -j $(JOBS) -C $(DST_DIR) install

local-release:
	make -f Makefile.suggested ARCH=sled11-x86-gcc4.x build
	cat $(DST_DIR)/module_lnrkinterface.pt | sed -e "s/ARCHS.*=.*$$/ARCHS = sled11-x86-gcc4.x/" > .my_module_lnrkinterface.pt
	reltool --local ./install --pt-file .my_module_lnrkinterface.pt --yes

release-only:
	reltool --domain robotkernel --force 1.5 --force 1.8 --yes -v

release:
	make -f Makefile.suggested build_all
	make -f Makefile.suggested release-only
